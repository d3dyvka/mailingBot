# План Реализации: Telegram Mailer MacOS App

## Обзор

Создание нативного MacOS приложения для массовой рассылки в Telegram с GUI интерфейсом. Приложение упаковывает существующий Python-скрипт (main.py) в standalone .app bundle с использованием PyInstaller, PyQt6 для GUI и Telethon для работы с Telegram API.

## Задачи

- [x] 1. Настройка структуры проекта и зависимостей
  - Создать requirements.txt с зависимостями: telethon, PyQt6, pyinstaller, keyring, hypothesis, pytest
  - Настроить директорию для хранения данных: ~/Library/Application Support/TelegramMailer/
  - Создать базовую структуру модулей: config/, telegram/, ui/, utils/
  - _Требования: 1.1, 1.4_

- [x] 2. Реализовать Config Manager с безопасным хранением
  - Создать ConfigManager класс для управления конфигурацией (config.json)
  - Интегрировать MacOS Keychain через библиотеку keyring для хранения API_HASH
  - Реализовать валидацию учетных данных (непустые строки)
  - Реализовать методы load_config(), save_config(), get_api_credentials(), save_api_credentials()
  - _Требования: 2.1, 2.2, 2.3, 2.7, 14.1_
  - [ ]* 2.1 Написать property-тест для валидации учетных данных
    - **Свойство 1: Валидация Учетных Данных**
    - **Проверяет: Требование 2.2**
  - [ ]* 2.2 Написать property-тест для round-trip персистентности конфигурации
    - **Свойство 2: Round-Trip Персистентности Конфигурации**
    - **Проверяет: Требования 2.3, 2.7**

- [x] 3. Реализовать Telegram Service с обработкой ошибок
  - Создать TelegramService класс-обертку над Telethon клиентом
  - Реализовать методы: connect(), disconnect(), is_authorized(), send_code_request(), sign_in()
  - Реализовать get_group_members() для получения списка участников группы
  - Реализовать send_message() с обработкой всех типов ошибок (FloodWait, UserPrivacy, PeerFlood, ChatAdminRequired)
  - Реализовать reconnect() с автоматическими попытками переподключения (до 3 раз)
  - Интегрировать сохранение Session_File с правами доступа 600
  - _Требования: 3.1-3.8, 4.1-4.5, 9.1-9.8, 11.1-11.6, 14.2_
  - [ ]* 3.1 Написать unit-тесты для обработки каждого типа ошибки Telegram
    - Тестировать UserPrivacyRestrictedError, PeerFloodError, FloodWaitError, ChatAdminRequiredError
    - _Требования: 9.1-9.5_
  - [ ]* 3.2 Написать property-тест для безопасности прав доступа к Session_File
    - **Свойство 11: Безопасность Прав Доступа**
    - **Проверяет: Требование 14.2**

- [x] 4. Реализовать Progress Tracker с append-only логикой
  - Создать ProgressTracker класс для отслеживания прогресса рассылки
  - Реализовать append-only запись в progress_{group_hash}.txt (никогда не перезаписывать файл)
  - Реализовать методы: load_progress(), append_sent_user(), mark_sent(), is_sent(), get_statistics()
  - Формат записи: ID_Пользователя/User_ID, Время_Отправки/Send_Time (двуязычные названия)
  - Реализовать reset_progress() для начала новой рассылки
  - _Требования: 6.6, 6.7, 12.1-12.7_
  - [ ]* 4.1 Написать property-тест для персистентности прогресса с append-only
    - **Свойство 4: Персистентность Прогресса с Append-Only**
    - **Проверяет: Требования 6.6, 6.7, 12.2**
  - [ ]* 4.2 Написать property-тест для уникальности отправки сообщений
    - **Свойство 10: Уникальность Отправки Сообщений**
    - **Проверяет: Требование 12.5**

- [x] 5. Реализовать Delay Calculator и Error Logger
  - Создать DelayCalculator класс для расчета оптимальных задержек
  - Реализовать calculate_delay() с формулой: (доступные_часы / количество_батчей)
  - ВАЖНО: Максимальная задержка между батчами - 24 часа (не больше!)
  - Размер батча всегда 18 человек (не часов!)
  - Реализовать validate_delay() для проверки минимальной безопасной задержки (20 часов)
  - Создать ErrorLogger класс для автоматического логирования в errors.txt
  - Реализовать log_error() и log_telegram_error() с полным контекстом
  - _Требования: 8.1-8.6, 9.6, 10.1-10.7_
  - [ ]* 5.1 Написать property-тест для корректности формулы расчета задержки
    - **Свойство 8: Корректность Формулы Расчета Задержки**
    - **Проверяет: Требование 10.4**
  - [ ]* 5.2 Написать property-тест для валидации безопасности задержки
    - **Свойство 9: Валидация Безопасности Задержки**
    - **Проверяет: Требование 10.7**
  - [ ]* 5.3 Написать property-тест для полноты логирования ошибок
    - **Свойство 7: Полнота Логирования Ошибок**
    - **Проверяет: Требование 9.6**

- [x] 6. Реализовать Power Manager для предотвращения режима сна
  - Создать PowerManager класс для управления режимом сна MacOS
  - Использовать caffeinate API через subprocess или pyobjc
  - Реализовать методы: prevent_sleep(), allow_sleep(), is_sleep_prevented()
  - Интегрировать с процессом рассылки (активировать при старте, деактивировать при завершении)
  - _Требования: 7.1-7.6_

- [x] 7. Создать GUI с PyQt6 - Main Window и панели конфигурации/аутентификации
  - Создать MainWindow класс с нативным MacOS дизайном
  - Реализовать ConfigPanel для ввода API_ID и API_HASH
  - Реализовать AuthPanel для аутентификации (номер телефона, код, пароль 2FA)
  - Реализовать поле ввода для ссылки на группу и отображение количества участников
  - Реализовать поле ввода для даты окончания рассылки
  - Интегрировать с ConfigManager и TelegramService
  - Реализовать load_window_geometry() и save_window_geometry()
  - _Требования: 2.1, 2.6, 3.1-3.8, 4.1-4.5, 10.1, 13.1-13.7_

- [x] 8. Создать Text Editor Panel с форматированием и Progress Panel
  - Создать TextEditorPanel с QTextEdit для rich text редактирования
  - Реализовать панель инструментов: Bold, Italic, Underline, Link, Emoji
  - Реализовать get_html_content() для конвертации в Telegram HTML теги
  - Добавить кнопку "Сохранить" для ручного сохранения сообщения
  - Создать ProgressPanel с прогресс-баром и счетчиками (отправлено/осталось/ошибок)
  - Реализовать таймер обратного отсчета для задержек между батчами
  - Добавить кнопки "Сбросить Прогресс" и "Выйти"
  - _Требования: 5.1-5.7, 6.1-6.7, 8.3, 8.6, 11.6, 12.7_
  - [ ]* 8.1 Написать property-тест для корректности HTML конвертации
    - **Свойство 3: Корректность HTML Конвертации**
    - **Проверяет: Требование 5.6**

- [x] 9. Реализовать основной цикл рассылки с батчами и задержками
  - Создать MailingService класс для координации процесса рассылки
  - Реализовать разбиение пользователей на батчи по 18 человек
  - Реализовать случайные задержки между сообщениями (15-45 секунд)
  - Реализовать задержку между батчами (рассчитанная DelayCalculator, максимум 24 часа)
  - Интегрировать с ProgressTracker для сохранения прогресса после каждой отправки
  - Интегрировать с ErrorLogger для автоматического логирования ошибок
  - Интегрировать с PowerManager для предотвращения режима сна
  - Реализовать обработку FloodWait с ожиданием (указанное время + 5-10 сек)
  - Реализовать возобновление рассылки с пропуском уже обработанных пользователей
  - _Требования: 6.1-6.7, 7.1-7.6, 8.1-8.6, 12.5, 15.1-15.6_
  - [ ]* 9.1 Написать property-тест для инварианта размера батча
    - **Свойство 5: Инвариант Размера Батча**
    - **Проверяет: Требование 8.1**
  - [ ]* 9.2 Написать property-тест для диапазона случайных задержек
    - **Свойство 6: Диапазон Случайных Задержек**
    - **Проверяет: Требование 8.4**
  - [ ]* 9.3 Написать unit-тесты для возобновления рассылки после перезапуска
    - Тестировать загрузку прогресса и пропуск обработанных пользователей
    - _Требования: 6.7, 12.5_

- [x] 10. Упаковка в MacOS .app bundle с PyInstaller
  - Создать .spec файл для PyInstaller с конфигурацией для MacOS
  - Настроить Universal Binary для поддержки Intel и Apple Silicon
  - Создать Info.plist с метаданными приложения и разрешениями
  - Добавить иконку приложения (.icns файл)
  - Настроить включение всех зависимостей (telethon, PyQt6, keyring)
  - Подписать код для совместимости с MacOS Gatekeeper (codesign)
  - Протестировать запуск .app bundle двойным кликом
  - Создать скрипт сборки (build.sh) для автоматизации процесса
  - _Требования: 1.1-1.6, 15.1_

## Примечания

- Задачи, помеченные `*`, являются опциональными и могут быть пропущены для быстрого MVP
- Каждая задача ссылается на конкретные требования для отслеживаемости
- Property-тесты должны запускаться с минимум 100 итерациями (настройка Hypothesis)
- Все property-тесты должны быть помечены комментарием: **Feature: telegram-mailer-macos-app, Property N: [текст свойства]**
- Размер батча всегда 18 человек, максимальная задержка между батчами - 24 часа
- Progress файл использует append-only логику (никогда не перезаписывается)
- Названия переменных в progress файле на двух языках: русский/английский
